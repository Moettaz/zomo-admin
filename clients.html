<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin - Zomo</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            background-color: #f4f6f8;
            display: grid;
            grid-template-columns: 200px 1fr;
            grid-template-rows: 60px 1fr;
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            background-color: #2c2c2c;
            color: white;
            grid-row: 1 / 3;
            padding: 20px 10px;
            display: flex;
            flex-direction: column;
        }

        .sidebar .logo-container {
            margin-bottom: 50px;
            text-align: center;
        }

        .sidebar .logo {
            width: 120px;
            height: auto;
        }

        .sidebar ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar li {
            margin-bottom: 5px;
        }

        .sidebar a {
            color: white;
            text-decoration: none;
            display: block;
            padding: 10px 15px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .sidebar a:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .sidebar .active {
            background-color: #FDBA1B;
            color: #2c3e50;
            font-weight: 500;
        }

        .sidebar .logout {
            margin-top: auto;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 15px;
        }

        .sidebar .logout a {
            background-color: #e74c3c;
            color: white;
            text-align: center;
            padding: 10px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        .sidebar .logout a:hover {
            background-color: #c0392b;
        }

        /* Header */
        .header {
            background-color: white;
            padding: 0 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }

        .header h1 {
            margin: 0;
            font-size: 1.2rem;
            color: #2c3e50;
            font-weight: 600;
        }

        .header .admin-connection {
            color: #7f8c8d;
            font-size: 0.85rem;
        }

        .header .admin-connection strong {
            color: #2c3e50;
        }

        /* Main Content */
        .main-content {
            padding: 20px;
            overflow-y: auto;
        }

        .card {
            background-color: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .card-title {
            color: #2c3e50;
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 1.1rem;
            font-weight: 600;
            padding-bottom: 10px;
            border-bottom: 1px solid #ecf0f1;
        }

        .accent-color {
            color: #FDBA1B;
        }

        /* Table Styles */
        .client-table-container {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .client-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
            table-layout: fixed;
        }

        .client-table th, .client-table td {
            border: 1px solid #ecf0f1;
            padding: 8px 10px;
            text-align: left;
            vertical-align: top;
            word-wrap: break-word;
        }

        .client-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
            position: sticky;
            top: 0;
        }

        .client-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .client-table tr:hover {
            background-color: #f1f7fe;
        }

        /* Column Widths */
        .client-table th:nth-child(1), .client-table td:nth-child(1) { width: 5%; }
        .client-table th:nth-child(2), .client-table td:nth-child(2) { width: 12%; }
        .client-table th:nth-child(3), .client-table td:nth-child(3) { width: 15%; }
        .client-table th:nth-child(4), .client-table td:nth-child(4) { width: 8%; }
        .client-table th:nth-child(5), .client-table td:nth-child(5) { width: 18%; }
        .client-table th:nth-child(6), .client-table td:nth-child(6) { width: 5%; }
        .client-table th:nth-child(7), .client-table td:nth-child(7) { width: 8%; }
        .client-table th:nth-child(8), .client-table td:nth-child(8) { width: 10%; }
        .client-table th:nth-child(9), .client-table td:nth-child(9) { width: 10%; }
        .client-table th:nth-child(10), .client-table td:nth-child(10) { width: 9%; }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .edit-button, .delete-button {
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s;
            flex: 1;
        }

        .edit-button {
            background-color: #2ecc71;
            color: white;
        }

        .edit-button:hover {
            background-color: #27ae60;
        }

        .delete-button {
            background-color: #e74c3c;
            color: white;
        }

        .delete-button:hover {
            background-color: #c0392b;
        }

        /* Responsive Adjustments */
        @media screen and (max-width: 1200px) {
            .client-table th:nth-child(4), 
            .client-table td:nth-child(4),
            .client-table th:nth-child(7),
            .client-table td:nth-child(7) {
                display: none;
            }
        }

        @media screen and (max-width: 992px) {
            body {
                grid-template-columns: 70px 1fr;
            }
            
            .sidebar {
                padding: 15px 5px;
            }
            
            .sidebar a span {
                display: none;
            }
            
            .sidebar .logo {
                width: 50px;
            }
        }
    </style>
</head>
<body>
    <div class="sidebar">
    <div class="logo-container">
        <img src="assets/zomo.png" alt="Zomo Logo" class="logo">
    </div>
    <ul>
        <li><a href="dashboard.html"><span>Dashboard</span></a></li>
        <li><a href="clients.html"   class="active"> <span>Clients</span></a></li>
        <li><a href="evaluation.html"><span>Evaluations</span></a></li>
        <li><a href="notifications.html"><span>Notifications</span></a></li>
        <li><a href="paiement.html"><span>Paiements</span></a></li>
    </ul>
    <div class="logout">
        <a href="connexion.html" onclick="return confirm('Êtes-vous sûr de vouloir vous déconnecter ?')">
            <span>Déconnecter</span>
        </a>
    </div>
</div>
    </div>

    <div class="header">
        <h1>Clients</h1>
        <div class="admin-connection">Connecté en tant que: <strong>Admin</strong></div>
    </div>

    <div class="main-content">
        <div class="card">
            <h3 class="card-title accent-color">Aperçu des clients</h3>
            <p>Zomo est une plateforme innovante de gestion de transport et de logistique destinée aux particuliers et aux professionnels. Son dashboard admin permet de suivre les clients, gérer les paiements et consulter les évaluations.</p>
        </div>

        <div class="card" id="clients-section">
            <h3 class="card-title">Gestion des Clients</h3>
            
            <div class="client-table-container">
                <table class="client-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nom</th>
                            <th>Email</th>                            
                            <th>Créé le</th>
                            <th>Modifié le</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Les lignes seront générées dynamiquement -->
                    </tbody>
                </table>
            </div>
            <div id="error-message" style="color: #e74c3c; margin-top: 10px;"></div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Fetch clients from API
            fetch('http://127.0.0.1:8000/api/clients', {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                mode: 'cors'
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(clients => {
                    const tbody = document.querySelector('.client-table tbody');
                    tbody.innerHTML = '';
                    document.getElementById('error-message').textContent = '';
                    if (!clients || !Array.isArray(clients.data)) {
                        throw new Error('Les données reçues ne sont pas un tableau');
                    }
                    clients.data.forEach(client => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${client.id || ''}</td>
                            <td>${client.username || ''}</td>
                            <td>${client.email || ''}</td>
                            <td>${client.created_at ? new Date(client.created_at).toLocaleString('fr-FR') : ''}</td>
                            <td>${client.updated_at ? new Date(client.updated_at).toLocaleString('fr-FR') : ''}</td>
                            <td class="action-buttons">
                                <button class="edit-button" title="Modifier" style="background: none; border: none; cursor: pointer; font-size: 1.1em;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="#2980b9" viewBox="0 0 20 20" style="vertical-align: middle;">
                                        <path d="M17.414 2.586a2 2 0 0 0-2.828 0l-9.5 9.5A2 2 0 0 0 4 13.914V16a1 1 0 0 0 1 1h2.086a2 2 0 0 0 1.414-.586l9.5-9.5a2 2 0 0 0 0-2.828l-1.586-1.586zm-2.121 1.415 1.586 1.586-9.5 9.5H5v-1.379l9.5-9.5z"/>
                                    </svg>
                                </button>
                                <button class="delete-button" title="Supprimer" style="background: none; border: none; cursor: pointer; font-size: 1.1em;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="#e74c3c" viewBox="0 0 20 20" style="vertical-align: middle;">
                                        <path d="M6 7a1 1 0 0 1 1 1v7a1 1 0 0 1-2 0V8a1 1 0 0 1 1-1zm4 0a1 1 0 0 1 1 1v7a1 1 0 0 1-2 0V8a1 1 0 0 1 1-1zm4 0a1 1 0 0 1 1 1v7a1 1 0 0 1-2 0V8a1 1 0 0 1 1-1z"/>
                                        <path d="M4 5V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v1h3a1 1 0 1 1 0 2h-1v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7H2a1 1 0 1 1 0-2h3zm2-1v1h8V4H6zm10 3H4v11h12V7z"/>
                                    </svg>
                                </button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                    attachEventListeners();
                })
                .catch(error => {
                    console.error('Error details:', error);
                    document.getElementById('error-message').textContent = `Erreur lors du chargement des clients: ${error.message}. Vérifiez que le serveur API est en cours d'exécution sur http://127.0.0.1:8001`;
                });

            function attachEventListeners() {
                // Gestion de la suppression
                document.querySelectorAll('.delete-button').forEach(button => {
                    button.addEventListener('click', function() {
                        const row = this.closest('tr');
                        const id = row.querySelector('td').textContent;
                        console.log(id);
                        if (confirm("Êtes-vous sûr de vouloir supprimer cet utilisateur ?")) {
                            fetch(`http://127.0.0.1:8000/api/clients/${id}`, {
                                method: 'DELETE',
                                headers: {
                                    'Accept': 'application/json',
                                    'Content-Type': 'application/json'
                                },
                                mode: 'cors'
                            })
                            .then(response => {
                                if (!response.ok) throw new Error('Erreur lors de la suppression');
                                row.style.transition = 'opacity 0.3s';
                                row.style.opacity = '0';
                                setTimeout(() => row.remove(), 300);
                                document.getElementById('error-message').textContent = '';
                            })
                            .catch(error => {
                                document.getElementById('error-message').textContent = 'Erreur lors de la suppression du client : ' + error.message;
                            });
                        }
                    });
                });

                // Gestion de l'édition
                document.querySelectorAll('.edit-button').forEach(button => {
                    button.addEventListener('click', function() {
                        const row = this.closest('tr');
                        const cells = row.querySelectorAll('td:not(:last-child)');
                        const isEditing = this.textContent === 'Enregistrer';
                        const id = row.querySelector('td').textContent;

                        if (isEditing) {
                            // Préparer les nouvelles valeurs
                            const updatedClient = {
                                id: cells[0].querySelector('input').value,
                                name: cells[1].querySelector('input').value,
                                email: cells[2].querySelector('input').value,
                                verified: cells[3].querySelector('input').value,
                                password: cells[4].querySelector('input').value,
                                role: cells[5].querySelector('input').value,
                                token: cells[6].querySelector('input').value,
                                created_at: cells[7].querySelector('input').value,
                                updated_at: cells[8].querySelector('input').value
                            };
                           
                            const url = `http://127.0.0.1:8000/api/clients/${updatedClient.id}`;
                            console.log('URL utilisée pour la requête PUT :', url);
                            fetch(url, {
                                method: 'PUT',
                                headers: {
                                    'Accept': 'application/json',
                                    'Content-Type': 'application/json'
                                },
                                mode: 'cors',
                                body: JSON.stringify(updatedClient)
                            })
                            .then(response => {
                                if (!response.ok) throw new Error('Erreur lors de la modification');
                                // Mettre à jour la ligne avec les nouvelles valeurs
                                cells.forEach((cell, i) => {
                                    if (cell.querySelector('input')) {
                                        cell.textContent = cell.querySelector('input').value;
                                    }
                                });
                                this.textContent = 'Modifier';
                                this.classList.remove('save-mode');
                                document.getElementById('error-message').textContent = '';
                            })
                            .catch(error => {
                                document.getElementById('error-message').textContent = 'Erreur lors de la modification du client : ' + error.message;
                            });
                        } else {
                            // Mode édition
                            cells.forEach(cell => {
                                const text = cell.textContent;
                                cell.innerHTML = `<input type=\"text\" value=\"${text}\" style=\"width:100%;\">`;
                            });
                            this.textContent = 'Enregistrer';
                            this.classList.add('save-mode');
                        }
                    });
                });
            }
        });
    </script>
</body>
</html>